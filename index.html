<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pixel Arter</title>
    <link rel="icon" href="https://raw.githubusercontent.com/mmk1102x/pixel-arter/refs/heads/main/favicon.ico">

    <style>
        :root {
            --bg-color: #f0f4f8;
            --panel-color: #ffffff;
            --primary-color: #4a90e2;
            --border-color: #ddd;
            --pixel-size: 20px;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-color);
            display: flex;
            flex-direction: column;
            align-items: center;
            height: 100vh;
            margin: 0;
            padding: 20px;
            box-sizing: border-box;
            overflow: hidden;
        }

        h1 {
            color: #333;
            margin: 0 0 10px 0;
            font-size: 1.8rem;
            font-weight: 800;
            letter-spacing: -1px;
        }

        /* Controls Bar */
        .controls {
            background: var(--panel-color);
            padding: 12px 20px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
            justify-content: center;
            margin-bottom: 15px;
            z-index: 10;
        }

        .control-group {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        label {
            font-size: 13px;
            font-weight: 700;
            color: #555;
        }

        input[type="number"] {
            width: 50px;
            padding: 4px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
        }

        input[type="color"] {
            border: none;
            width: 32px;
            height: 32px;
            cursor: pointer;
            background: none;
            padding: 0;
        }

        button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.85rem;
            transition: background 0.2s, transform 0.1s;
            white-space: nowrap;
        }

        button:active { transform: scale(0.98); }
        button:hover { filter: brightness(1.1); }
        button:disabled { background-color: #ccc; cursor: not-allowed; }
        
        button#clear-btn { background-color: #e74c3c; }
        button#grid-toggle-btn { background-color: #7f8c8d; }
        .history-btn { background-color: #34495e; }

        /* DROPDOWN MENU STYLES */
        .dropdown {
            position: relative;
            display: inline-block;
        }

        .dropdown-content {
            display: none;
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            background-color: #fff;
            min-width: 140px;
            box-shadow: 0 8px 16px rgba(0,0,0,0.2);
            border-radius: 8px;
            z-index: 100;
            overflow: hidden;
            margin-top: 5px;
        }

        .dropdown:hover .dropdown-content {
            display: block;
        }

        .dropdown-btn {
            background-color: #27ae60; /* Green for Export */
        }
        .import-btn-main {
            background-color: #d35400; /* Orange for Import */
        }

        .dropdown-content button {
            background: none;
            color: #333;
            width: 100%;
            text-align: left;
            padding: 10px 15px;
            border-radius: 0;
            font-weight: normal;
        }
        
        .dropdown-content button:hover {
            background-color: #f1f1f1;
            filter: none;
        }

        .instructions {
            font-size: 0.8rem; 
            color: #666; 
            margin-bottom: 10px;
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            justify-content: center;
        }

        /* Canvas Container */
        #canvas-container {
            flex: 1;
            width: 100%;
            max-width: 90vw;
            border: 2px solid #ccc;
            box-shadow: inset 0 0 20px rgba(0,0,0,0.05);
            background-color: #e5e5e5;
            overflow: hidden; 
            position: relative;
            border-radius: 8px;
            display: flex;
            align-items: flex-start;
            justify-content: flex-start;
        }

        .grid {
            display: grid;
            background-color: #ccc; 
            gap: 1px; 
            box-shadow: 0 0 10px rgba(0,0,0,0.2);
            flex: none; 
            transform-origin: center center;
            margin: auto; 
        }

        .grid.hide-grid {
            gap: 0;
            background-color: transparent;
        }

        .pixel {
            background-color: #fff;
            width: var(--pixel-size);
            height: var(--pixel-size);
            user-select: none;
        }
        
        body.is-panning #canvas-container { cursor: grabbing; }
        body.space-pressed #canvas-container { cursor: grab; }

        /* MODAL STYLES */
        .modal-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            backdrop-filter: blur(2px);
        }
        .modal-content {
            background: white;
            padding: 20px;
            border-radius: 8px;
            width: 500px;
            max-width: 90%;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        .modal-header { font-weight: bold; font-size: 1.2rem; color: #333; }
        textarea#import-text {
            width: 100%;
            height: 150px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-family: monospace;
            font-size: 0.9rem;
            resize: vertical;
            box-sizing: border-box;
        }
        .modal-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }
        .hidden { display: none !important; }
        
    </style>
</head>
<body>

    <h1>Pixel Arter</h1>

    <div class="controls">
        <div class="control-group">
            <label>H:</label>
            <input type="number" id="input-height" value="16" min="1" max="100">
        </div>
        <div class="control-group">
            <label>W:</label>
            <input type="number" id="input-width" value="16" min="1" max="100">
        </div>
        <button id="create-btn">New</button>
        
        <div class="control-group" style="margin: 0 5px; border-left: 1px solid #ddd; padding-left: 5px;">
            <input type="color" id="color-picker" value="#000000">
        </div>

        <button id="undo-btn" class="history-btn" title="Ctrl+Z">‚Ü∂</button>
        <button id="redo-btn" class="history-btn" title="Ctrl+Y">‚Ü∑</button>

        <button id="grid-toggle-btn">Grid</button>
        <button id="clear-btn">Clear</button>
        
        <!-- EXPORT DROPDOWN -->
        <div class="dropdown">
            <button class="dropdown-btn">Export ‚ñº</button>
            <div class="dropdown-content">
                <button id="download-png-btn">Export PNG</button>
                <button id="download-ico-btn">Export ICO</button>
                <button id="copy-json-btn">Copy JSON Text</button>
                <button id="save-json-file-btn">Save JSON File</button>
            </div>
        </div>

        <!-- IMPORT DROPDOWN -->
        <div class="dropdown">
            <button class="import-btn-main">Import ‚ñº</button>
            <div class="dropdown-content">
                <button id="import-json-btn">Paste JSON Text</button>
                <button id="import-png-btn">Upload PNG</button>
            </div>
        </div>
        
        <!-- Hidden file inputs -->
        <input type="file" id="file-input-png" style="display: none;" accept="image/png">
    </div>

    <div class="instructions">
        <span>üñ±Ô∏è <b>Left:</b> Draw</span>
        <span>üñ±Ô∏è <b>Right:</b> Erase</span>
        <span>üñ±Ô∏è <b>Wheel Click:</b> Pick Color</span>
        <span>üñ±Ô∏è <b>Space+Left:</b> Pan</span>
    </div>

    <div id="canvas-container">
        <div id="pixel-canvas" class="grid"></div>
    </div>

    <!-- IMPORT JSON MODAL -->
    <div id="import-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="modal-header">Import JSON</div>
            <p style="font-size:0.9rem; color:#666; margin:0;">Paste your JSON text code below:</p>
            <textarea id="import-text" placeholder='{"width": 16, "height": 16, "pixels": [...]}'></textarea>
            <div class="modal-actions">
                <button id="cancel-import-btn" style="background-color: #95a5a6;">Cancel</button>
                <button id="load-text-btn">Load Text</button>
            </div>
        </div>
    </div>

    <script>
        const container = document.getElementById('canvas-container');
        const canvasDiv = document.getElementById('pixel-canvas');
        const heightInput = document.getElementById('input-height');
        const widthInput = document.getElementById('input-width');
        const colorPicker = document.getElementById('color-picker');
        
        // Buttons
        const createBtn = document.getElementById('create-btn');
        const clearBtn = document.getElementById('clear-btn');
        const gridToggleBtn = document.getElementById('grid-toggle-btn');
        const undoBtn = document.getElementById('undo-btn');
        const redoBtn = document.getElementById('redo-btn');
        
        // Export Menu Items
        const downloadPngBtn = document.getElementById('download-png-btn');
        const downloadIcoBtn = document.getElementById('download-ico-btn');
        const copyJsonBtn = document.getElementById('copy-json-btn');
        const saveJsonFileBtn = document.getElementById('save-json-file-btn');
        
        // Import Menu Items & Elements
        const importJsonBtn = document.getElementById('import-json-btn');
        const importPngBtn = document.getElementById('import-png-btn');
        const fileInputPng = document.getElementById('file-input-png');
        
        // Modal Elements
        const importModal = document.getElementById('import-modal');
        const importText = document.getElementById('import-text');
        const cancelImportBtn = document.getElementById('cancel-import-btn');
        const loadTextBtn = document.getElementById('load-text-btn');

        let isDrawing = false;
        let isErasing = false;
        let isSpacePressed = false;
        let currentPixelSize = 20;

        // --- HISTORY STATE ---
        let history = [];
        let historyStep = -1;
        const MAX_HISTORY = 50;

        function saveState() {
            if (historyStep < history.length - 1) {
                history = history.slice(0, historyStep + 1);
            }
            const currentPixels = Array.from(document.querySelectorAll('.pixel')).map(p => p.style.backgroundColor);
            history.push(currentPixels);
            if (history.length > MAX_HISTORY) history.shift(); 
            else historyStep++;
            updateButtons();
        }

        function restoreState(pixelColors) {
            const pixels = document.querySelectorAll('.pixel');
            pixels.forEach((p, index) => {
                if (pixels[index]) p.style.backgroundColor = pixelColors[index];
            });
        }

        function undo() {
            if (historyStep > 0) {
                historyStep--;
                restoreState(history[historyStep]);
                updateButtons();
            }
        }

        function redo() {
            if (historyStep < history.length - 1) {
                historyStep++;
                restoreState(history[historyStep]);
                updateButtons();
            }
        }

        function updateButtons() {
            undoBtn.disabled = historyStep <= 0;
            redoBtn.disabled = historyStep >= history.length - 1;
        }

        // --- HELPERS ---
        function rgbToHex(col) {
            if(!col || col === 'transparent' || col === 'rgba(0, 0, 0, 0)') return '#ffffff';
            if(col.startsWith('#')) return col;
            if(col.startsWith('rgb')){
                let parts = col.replace('rgb(','').replace(')','').replace('rgba(','').split(',');
                let r=parseInt(parts[0], 10).toString(16);
                let g=parseInt(parts[1], 10).toString(16);
                let b=parseInt(parts[2], 10).toString(16);
                r=r.length==1?'0'+r:r; g=g.length==1?'0'+g:g; b=b.length==1?'0'+b:b;
                return '#'+r+g+b;
            }
            return '#ffffff';
        }

        function componentToHex(c) {
            var hex = c.toString(16);
            return hex.length == 1 ? "0" + hex : hex;
        }

        // --- GRID GEN ---
        function makeGrid() {
            canvasDiv.innerHTML = '';
            history = [];
            historyStep = -1;

            const height = parseInt(heightInput.value);
            const width = parseInt(widthInput.value);

            canvasDiv.style.gridTemplateColumns = `repeat(${width}, 1fr)`;
            canvasDiv.style.width = 'fit-content'; 

            for (let i = 0; i < height * width; i++) {
                const pixel = document.createElement('div');
                pixel.classList.add('pixel');
                pixel.style.backgroundColor = 'rgb(255, 255, 255)'; 

                pixel.addEventListener('mousedown', (e) => {
                    if (isSpacePressed) return;
                    e.preventDefault();

                    if (e.button === 1) { // Middle Click
                        e.stopPropagation();
                        const currentColor = pixel.style.backgroundColor;
                        colorPicker.value = rgbToHex(currentColor);
                        return;
                    }

                    if (e.button === 2) { // Right Click
                        isErasing = true;
                        pixel.style.backgroundColor = '#ffffff';
                    } else if (e.button === 0) { // Left Click
                        isDrawing = true;
                        pixel.style.backgroundColor = colorPicker.value;
                    }
                });

                pixel.addEventListener('mouseover', () => {
                    if (isSpacePressed) return; 
                    if (isDrawing) pixel.style.backgroundColor = colorPicker.value;
                    else if (isErasing) pixel.style.backgroundColor = '#ffffff';
                });
                
                pixel.addEventListener('contextmenu', (e) => e.preventDefault());
                canvasDiv.appendChild(pixel);
            }
            saveState();
            container.scrollLeft = 0;
            container.scrollTop = 0;
            currentPixelSize = 20;
            updateZoom();
        }

        // --- GLOBAL LISTENERS ---
        window.addEventListener('mouseup', () => {
            if (isDrawing || isErasing) {
                isDrawing = false;
                isErasing = false;
                saveState();
            }
        });

        document.addEventListener('keydown', (e) => {
            if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 'z') {
                e.preventDefault();
                e.shiftKey ? redo() : undo();
            }
            if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 'y') {
                e.preventDefault();
                redo();
            }
            if (e.code === 'Space' && !e.repeat) {
                isSpacePressed = true;
                document.body.classList.add('space-pressed');
            }
        });

        document.addEventListener('keyup', (e) => {
            if (e.code === 'Space') {
                isSpacePressed = false;
                document.body.classList.remove('space-pressed');
                isDrawing = false;
            }
        });

        // --- PANNING LOGIC ---
        let startX, startY, scrollLeft, scrollTop;

        container.addEventListener('mousedown', (e) => {
            if (e.button === 1 || (isSpacePressed && e.button === 0)) {
                e.preventDefault();
                document.body.classList.add('is-panning');
                startX = e.clientX;
                startY = e.clientY;
                scrollLeft = container.scrollLeft;
                scrollTop = container.scrollTop;
                document.addEventListener('mousemove', onMouseMove);
                document.addEventListener('mouseup', onMouseUp);
            }
        });

        function onMouseMove(e) {
            e.preventDefault();
            const x = e.clientX;
            const y = e.clientY;
            const walkX = (x - startX);
            const walkY = (y - startY);
            container.scrollLeft = scrollLeft - walkX;
            container.scrollTop = scrollTop - walkY;
        }

        function onMouseUp() {
            document.body.classList.remove('is-panning');
            document.removeEventListener('mousemove', onMouseMove);
            document.removeEventListener('mouseup', onMouseUp);
        }

        // --- BUTTONS ---
        undoBtn.addEventListener('click', undo);
        redoBtn.addEventListener('click', redo);
        createBtn.addEventListener('click', makeGrid);
        clearBtn.addEventListener('click', () => {
            document.querySelectorAll('.pixel').forEach(p => p.style.backgroundColor = '#ffffff');
            saveState();
        });
        
        gridToggleBtn.addEventListener('click', () => canvasDiv.classList.toggle('hide-grid'));

        function updateZoom() {
            document.documentElement.style.setProperty('--pixel-size', `${currentPixelSize}px`);
        }
        container.addEventListener('wheel', (e) => {
            e.preventDefault();
            const delta = Math.sign(e.deltaY) * -1;
            currentPixelSize += (delta * 2);
            if (currentPixelSize < 2) currentPixelSize = 2;
            if (currentPixelSize > 120) currentPixelSize = 120;
            updateZoom();
        }, { passive: false });


        // ==========================================
        // --- EXPORT ENGINE ---
        // ==========================================

        function downloadBlob(blob, filename) {
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = filename;
            link.click();
            URL.revokeObjectURL(link.href);
        }

        function generateCanvas(scale = 1) {
            const w = parseInt(widthInput.value);
            const h = parseInt(heightInput.value);
            const canvas = document.createElement('canvas');
            canvas.width = w * scale;
            canvas.height = h * scale;
            const ctx = canvas.getContext('2d');
            const pixels = document.querySelectorAll('.pixel');
            pixels.forEach((p, i) => {
                const colIndex = i % w;
                const rowIndex = Math.floor(i / w);
                const color = p.style.backgroundColor;
                ctx.fillStyle = color && color !== '' ? color : '#ffffff';
                ctx.fillRect(colIndex * scale, rowIndex * scale, scale, scale);
            });
            return canvas;
        }

        downloadPngBtn.addEventListener('click', () => {
            const canvas = generateCanvas(20); 
            canvas.toBlob(blob => downloadBlob(blob, 'pixel-art.png'));
        });

        downloadIcoBtn.addEventListener('click', () => {
            const canvas = generateCanvas(1);
            canvas.toBlob(async (blob) => {
                const icoBlob = await createIcoFromPngBlob(blob, canvas.width, canvas.height);
                downloadBlob(icoBlob, 'favicon.ico');
            }, 'image/png');
        });

        async function createIcoFromPngBlob(pngBlob, width, height) {
            const pngData = new Uint8Array(await pngBlob.arrayBuffer());
            const fileSize = pngData.length;
            const header = new Uint8Array([0, 0, 1, 0, 1, 0]);
            const entry = new DataView(new ArrayBuffer(16));
            const w = width >= 256 ? 0 : width;
            const h = height >= 256 ? 0 : height;
            entry.setUint8(0, w); entry.setUint8(1, h);
            entry.setUint8(2, 0); entry.setUint8(3, 0);
            entry.setUint16(4, 1, true); entry.setUint16(6, 32, true);
            entry.setUint32(8, fileSize, true); entry.setUint32(12, 22, true);
            return new Blob([header, entry, pngData], { type: 'image/vnd.microsoft.icon' });
        }

        // --- JSON EXPORT ---

        function getJsonData() {
            const width = parseInt(widthInput.value);
            const height = parseInt(heightInput.value);
            const pixels = Array.from(document.querySelectorAll('.pixel')).map(p => {
                return rgbToHex(p.style.backgroundColor);
            });
            return { width, height, pixels };
        }

        copyJsonBtn.addEventListener('click', () => {
            const data = getJsonData();
            const jsonString = JSON.stringify(data, null, 2);
            navigator.clipboard.writeText(jsonString).then(() => alert("JSON Copied to Clipboard"));
        });

        saveJsonFileBtn.addEventListener('click', () => {
            const data = getJsonData();
            const jsonString = JSON.stringify(data, null, 2);
            const blob = new Blob([jsonString], { type: "application/json" });
            downloadBlob(blob, 'pixel-art.json');
        });

        // ==========================================
        // --- IMPORT ENGINE ---
        // ==========================================

        // 1. JSON TEXT IMPORT
        importJsonBtn.addEventListener('click', () => {
            importModal.classList.remove('hidden');
            importText.value = '';
            importText.focus();
        });

        cancelImportBtn.addEventListener('click', () => {
            importModal.classList.add('hidden');
        });

        loadTextBtn.addEventListener('click', () => {
            try {
                const data = JSON.parse(importText.value);
                if (!data.width || !data.height || !data.pixels) throw new Error("Invalid Format");
                
                widthInput.value = data.width;
                heightInput.value = data.height;
                makeGrid();

                const pixels = document.querySelectorAll('.pixel');
                data.pixels.forEach((color, index) => {
                    if (pixels[index]) pixels[index].style.backgroundColor = color;
                });
                saveState();
                importModal.classList.add('hidden');
            } catch (e) {
                alert('Error: ' + e.message);
            }
        });
        
        // 2. PNG IMAGE IMPORT
        importPngBtn.addEventListener('click', () => {
            fileInputPng.click();
        });

        fileInputPng.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (event) => {
                const img = new Image();
                img.onload = () => {
                    // Limit dimensions to prevent browser crashes
                    if (img.width > 100 || img.height > 100) {
                        if (!confirm("Image is larger than 100x100. It will be cropped or resized. Continue?")) return;
                    }
                    
                    // Set inputs to image size (clamped to 100)
                    const w = Math.min(img.width, 100);
                    const h = Math.min(img.height, 100);
                    
                    widthInput.value = w;
                    heightInput.value = h;
                    makeGrid();

                    // Draw to temp canvas to read pixels
                    const tempCanvas = document.createElement('canvas');
                    tempCanvas.width = w;
                    tempCanvas.height = h;
                    const ctx = tempCanvas.getContext('2d');
                    ctx.drawImage(img, 0, 0);

                    const imgData = ctx.getImageData(0, 0, w, h).data;
                    const pixels = document.querySelectorAll('.pixel');

                    for (let i = 0; i < pixels.length; i++) {
                        const r = imgData[i * 4];
                        const g = imgData[i * 4 + 1];
                        const b = imgData[i * 4 + 2];
                        const a = imgData[i * 4 + 3];

                        if (a < 128) {
                            pixels[i].style.backgroundColor = '#ffffff'; // Transparent treated as white
                        } else {
                            const hex = "#" + componentToHex(r) + componentToHex(g) + componentToHex(b);
                            pixels[i].style.backgroundColor = hex;
                        }
                    }
                    saveState();
                };
                img.src = event.target.result;
            };
            reader.readAsDataURL(file);
            fileInputPng.value = ''; // Reset input
        });

        // Init
        window.onload = makeGrid;
        importModal.addEventListener('click', (e) => {
            if(e.target === importModal) importModal.classList.add('hidden');
        });
    </script>
</body>
</html>