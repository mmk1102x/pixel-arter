<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pixel Arter</title>
    <link rel="icon" href="https://raw.githubusercontent.com/mmk1102x/pixel-arter/refs/heads/main/favicon.ico">

    <style>
        :root {
            --bg-color: #f0f4f8;
            --panel-color: #ffffff;
            --primary-color: #4a90e2;
            --border-color: #ddd;
            --pixel-size: 20px;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-color);
            display: flex;
            flex-direction: column;
            align-items: center;
            height: 100vh;
            margin: 0;
            padding: 20px;
            box-sizing: border-box;
            overflow: hidden;
        }

        h1 {
            color: #333;
            margin: 0 0 10px 0;
            font-size: 1.8rem;
            font-weight: 800;
            letter-spacing: -1px;
        }

        /* Controls Bar */
        .controls {
            background: var(--panel-color);
            padding: 12px 20px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
            justify-content: center;
            margin-bottom: 15px;
            z-index: 10;
        }

        .control-group {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        label {
            font-size: 13px;
            font-weight: 700;
            color: #555;
        }

        input[type="number"] {
            width: 50px;
            padding: 4px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
        }

        input[type="color"] {
            border: none;
            width: 32px;
            height: 32px;
            cursor: pointer;
            background: none;
            padding: 0;
        }

        button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.85rem;
            transition: background 0.2s, transform 0.1s;
        }

        button:active { transform: scale(0.98); }
        button:hover { filter: brightness(1.1); }
        button:disabled { background-color: #ccc; cursor: not-allowed; }
        
        button#clear-btn { background-color: #e74c3c; }
        button#download-btn { background-color: #27ae60; }
        button#download-ico-btn { background-color: #8e44ad; }
        button#grid-toggle-btn { background-color: #7f8c8d; }
        
        /* JSON Group Colors */
        button#copy-json-btn { background-color: #f39c12; }
        button#save-json-file-btn { background-color: #d35400; }
        button#import-btn { background-color: #34495e; }
        
        .history-btn { background-color: #34495e; }

        .instructions {
            font-size: 0.8rem; 
            color: #666; 
            margin-bottom: 10px;
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            justify-content: center;
        }

        /* Canvas Container */
        #canvas-container {
            flex: 1;
            width: 100%;
            max-width: 90vw;
            border: 2px solid #ccc;
            box-shadow: inset 0 0 20px rgba(0,0,0,0.05);
            background-color: #e5e5e5;
            overflow: hidden; 
            position: relative;
            border-radius: 8px;
            display: flex;
            align-items: flex-start;
            justify-content: flex-start;
        }

        .grid {
            display: grid;
            background-color: #ccc; 
            gap: 1px; 
            box-shadow: 0 0 10px rgba(0,0,0,0.2);
            flex: none; 
            transform-origin: center center;
            margin: auto; 
        }

        .grid.hide-grid {
            gap: 0;
            background-color: transparent;
        }

        .pixel {
            background-color: #fff;
            width: var(--pixel-size);
            height: var(--pixel-size);
            user-select: none;
        }
        
        body.is-panning #canvas-container { cursor: grabbing; }
        body.space-pressed #canvas-container { cursor: grab; }

        /* MODAL STYLES */
        .modal-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            backdrop-filter: blur(2px);
        }
        .modal-content {
            background: white;
            padding: 20px;
            border-radius: 8px;
            width: 500px;
            max-width: 90%;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        .modal-header { font-weight: bold; font-size: 1.2rem; color: #333; }
        textarea#import-text {
            width: 100%;
            height: 150px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-family: monospace;
            font-size: 0.9rem;
            resize: vertical;
            box-sizing: border-box;
        }
        .modal-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }
        .hidden { display: none !important; }
        
    </style>
</head>
<body>

    <h1>Pixel Arter</h1>

    <div class="controls">
        <div class="control-group">
            <label>H:</label>
            <input type="number" id="input-height" value="16" min="1" max="100">
        </div>
        <div class="control-group">
            <label>W:</label>
            <input type="number" id="input-width" value="16" min="1" max="100">
        </div>
        <button id="create-btn">New</button>
        
        <div class="control-group" style="margin: 0 5px; border-left: 1px solid #ddd; padding-left: 5px;">
            <input type="color" id="color-picker" value="#000000">
        </div>

        <button id="undo-btn" class="history-btn" title="Ctrl+Z">‚Ü∂</button>
        <button id="redo-btn" class="history-btn" title="Ctrl+Y">‚Ü∑</button>

        <button id="grid-toggle-btn">Grid</button>
        <button id="clear-btn">Clear</button>
        <button id="download-btn">PNG</button>
        <button id="download-ico-btn">ICO</button>
        
        <!-- JSON Controls -->
        <button id="copy-json-btn" title="Copy Text to Clipboard">Copy JSON</button>
        <button id="save-json-file-btn" title="Download .json file">Save File</button>
        <button id="import-btn" title="Paste Text or Upload">Import JSON</button>
    </div>

    <div class="instructions">
        <span>üñ±Ô∏è <b>Left:</b> Draw</span>
        <span>üñ±Ô∏è <b>Right:</b> Erase</span>
        <span>üñ±Ô∏è <b>Middle</b> (or Space+Left): Pan</span>
        <span>üñ±Ô∏è <b>Wheel:</b> Zoom</span>
        <span>‚å®Ô∏è <b>Ctrl+Z/Y:</b> Undo/Redo</span>
    </div>

    <div id="canvas-container">
        <div id="pixel-canvas" class="grid"></div>
    </div>

    <!-- IMPORT MODAL -->
    <div id="import-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="modal-header">Import JSON</div>
            <p style="font-size:0.9rem; color:#666; margin:0;">Paste your JSON text code below:</p>
            <textarea id="import-text" placeholder='{"width": 16, "height": 16, "pixels": [...]}'></textarea>
            <div class="modal-actions">
                <button id="cancel-import-btn" style="background-color: #95a5a6;">Cancel</button>
                <button id="load-text-btn">Load Text</button>
            </div>
        </div>
    </div>

    <script>
        const container = document.getElementById('canvas-container');
        const canvasDiv = document.getElementById('pixel-canvas');
        const heightInput = document.getElementById('input-height');
        const widthInput = document.getElementById('input-width');
        const colorPicker = document.getElementById('color-picker');
        
        // Buttons
        const createBtn = document.getElementById('create-btn');
        const clearBtn = document.getElementById('clear-btn');
        const gridToggleBtn = document.getElementById('grid-toggle-btn');
        const downloadBtn = document.getElementById('download-btn');
        const downloadIcoBtn = document.getElementById('download-ico-btn');
        const undoBtn = document.getElementById('undo-btn');
        const redoBtn = document.getElementById('redo-btn');
        
        // JSON Buttons
        const copyJsonBtn = document.getElementById('copy-json-btn');
        const saveJsonFileBtn = document.getElementById('save-json-file-btn');
        const importBtn = document.getElementById('import-btn');
        
        // Modal Elements
        const importModal = document.getElementById('import-modal');
        const importText = document.getElementById('import-text');
        const cancelImportBtn = document.getElementById('cancel-import-btn');
        const loadTextBtn = document.getElementById('load-text-btn');

        let isDrawing = false;
        let isErasing = false;
        let isSpacePressed = false;
        let currentPixelSize = 20;

        // --- HISTORY STATE ---
        let history = [];
        let historyStep = -1;
        const MAX_HISTORY = 50;

        function saveState() {
            if (historyStep < history.length - 1) {
                history = history.slice(0, historyStep + 1);
            }
            const currentPixels = Array.from(document.querySelectorAll('.pixel')).map(p => p.style.backgroundColor);
            history.push(currentPixels);
            if (history.length > MAX_HISTORY) history.shift(); 
            else historyStep++;
            updateButtons();
        }

        function restoreState(pixelColors) {
            const pixels = document.querySelectorAll('.pixel');
            pixels.forEach((p, index) => {
                if (pixels[index]) p.style.backgroundColor = pixelColors[index];
            });
        }

        function undo() {
            if (historyStep > 0) {
                historyStep--;
                restoreState(history[historyStep]);
                updateButtons();
            }
        }

        function redo() {
            if (historyStep < history.length - 1) {
                historyStep++;
                restoreState(history[historyStep]);
                updateButtons();
            }
        }

        function updateButtons() {
            undoBtn.disabled = historyStep <= 0;
            redoBtn.disabled = historyStep >= history.length - 1;
        }

        // --- GRID GEN ---
        function makeGrid() {
            canvasDiv.innerHTML = '';
            history = [];
            historyStep = -1;

            const height = parseInt(heightInput.value);
            const width = parseInt(widthInput.value);

            canvasDiv.style.gridTemplateColumns = `repeat(${width}, 1fr)`;
            canvasDiv.style.width = 'fit-content'; 

            for (let i = 0; i < height * width; i++) {
                const pixel = document.createElement('div');
                pixel.classList.add('pixel');
                pixel.style.backgroundColor = 'rgb(255, 255, 255)'; 

                pixel.addEventListener('mousedown', (e) => {
                    if (e.button === 1 || isSpacePressed) return; 
                    e.preventDefault();
                    if (e.button === 2) {
                        isErasing = true;
                        pixel.style.backgroundColor = '#ffffff';
                    } else if (e.button === 0) {
                        isDrawing = true;
                        pixel.style.backgroundColor = colorPicker.value;
                    }
                });

                pixel.addEventListener('mouseover', () => {
                    if (isSpacePressed) return; 
                    if (isDrawing) pixel.style.backgroundColor = colorPicker.value;
                    else if (isErasing) pixel.style.backgroundColor = '#ffffff';
                });
                
                pixel.addEventListener('contextmenu', (e) => e.preventDefault());
                canvasDiv.appendChild(pixel);
            }
            saveState();
            container.scrollLeft = 0;
            container.scrollTop = 0;
            currentPixelSize = 20;
            updateZoom();
        }

        // --- GLOBAL LISTENERS ---
        window.addEventListener('mouseup', () => {
            if (isDrawing || isErasing) {
                isDrawing = false;
                isErasing = false;
                saveState();
            }
        });

        document.addEventListener('keydown', (e) => {
            if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 'z') {
                e.preventDefault();
                e.shiftKey ? redo() : undo();
            }
            if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 'y') {
                e.preventDefault();
                redo();
            }
            if (e.code === 'Space' && !e.repeat) {
                isSpacePressed = true;
                document.body.classList.add('space-pressed');
            }
        });

        document.addEventListener('keyup', (e) => {
            if (e.code === 'Space') {
                isSpacePressed = false;
                document.body.classList.remove('space-pressed');
                isDrawing = false;
            }
        });

        // --- PANNING LOGIC ---
        let startX, startY, scrollLeft, scrollTop;

        container.addEventListener('mousedown', (e) => {
            if (e.button === 1 || (isSpacePressed && e.button === 0)) {
                e.preventDefault();
                document.body.classList.add('is-panning');
                startX = e.clientX;
                startY = e.clientY;
                scrollLeft = container.scrollLeft;
                scrollTop = container.scrollTop;
                document.addEventListener('mousemove', onMouseMove);
                document.addEventListener('mouseup', onMouseUp);
            }
        });

        function onMouseMove(e) {
            e.preventDefault();
            const x = e.clientX;
            const y = e.clientY;
            const walkX = (x - startX);
            const walkY = (y - startY);
            container.scrollLeft = scrollLeft - walkX;
            container.scrollTop = scrollTop - walkY;
        }

        function onMouseUp() {
            document.body.classList.remove('is-panning');
            document.removeEventListener('mousemove', onMouseMove);
            document.removeEventListener('mouseup', onMouseUp);
        }

        // --- BUTTONS ---
        undoBtn.addEventListener('click', undo);
        redoBtn.addEventListener('click', redo);
        createBtn.addEventListener('click', makeGrid);
        clearBtn.addEventListener('click', () => {
            document.querySelectorAll('.pixel').forEach(p => p.style.backgroundColor = '#ffffff');
            saveState();
        });
        
        gridToggleBtn.addEventListener('click', () => canvasDiv.classList.toggle('hide-grid'));

        function updateZoom() {
            document.documentElement.style.setProperty('--pixel-size', `${currentPixelSize}px`);
        }
        container.addEventListener('wheel', (e) => {
            e.preventDefault();
            const delta = Math.sign(e.deltaY) * -1;
            currentPixelSize += (delta * 2);
            if (currentPixelSize < 2) currentPixelSize = 2;
            if (currentPixelSize > 120) currentPixelSize = 120;
            updateZoom();
        }, { passive: false });


        // ==========================================
        // --- EXPORT/IMPORT ENGINE ---
        // ==========================================

        function downloadBlob(blob, filename) {
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = filename;
            link.click();
            URL.revokeObjectURL(link.href);
        }

        function generateCanvas(scale = 1) {
            const w = parseInt(widthInput.value);
            const h = parseInt(heightInput.value);
            const canvas = document.createElement('canvas');
            canvas.width = w * scale;
            canvas.height = h * scale;
            const ctx = canvas.getContext('2d');
            const pixels = document.querySelectorAll('.pixel');
            pixels.forEach((p, i) => {
                const colIndex = i % w;
                const rowIndex = Math.floor(i / w);
                const color = p.style.backgroundColor;
                ctx.fillStyle = color && color !== '' ? color : '#ffffff';
                ctx.fillRect(colIndex * scale, rowIndex * scale, scale, scale);
            });
            return canvas;
        }

        downloadBtn.addEventListener('click', () => {
            const canvas = generateCanvas(20); 
            canvas.toBlob(blob => downloadBlob(blob, 'pixel-art.png'));
        });

        downloadIcoBtn.addEventListener('click', () => {
            const canvas = generateCanvas(1);
            canvas.toBlob(async (blob) => {
                const icoBlob = await createIcoFromPngBlob(blob, canvas.width, canvas.height);
                downloadBlob(icoBlob, 'favicon.ico');
            }, 'image/png');
        });

        async function createIcoFromPngBlob(pngBlob, width, height) {
            const pngData = new Uint8Array(await pngBlob.arrayBuffer());
            const fileSize = pngData.length;
            const header = new Uint8Array([0, 0, 1, 0, 1, 0]);
            const entry = new DataView(new ArrayBuffer(16));
            const w = width >= 256 ? 0 : width;
            const h = height >= 256 ? 0 : height;
            entry.setUint8(0, w); entry.setUint8(1, h);
            entry.setUint8(2, 0); entry.setUint8(3, 0);
            entry.setUint16(4, 1, true); entry.setUint16(6, 32, true);
            entry.setUint32(8, fileSize, true); entry.setUint32(12, 22, true);
            return new Blob([header, entry, pngData], { type: 'image/vnd.microsoft.icon' });
        }

        // --- JSON LOGIC ---

        function getJsonData() {
            const width = parseInt(widthInput.value);
            const height = parseInt(heightInput.value);
            const pixels = Array.from(document.querySelectorAll('.pixel')).map(p => {
                // normalize colors
                let c = p.style.backgroundColor;
                if(!c) c = '#ffffff';
                return c;
            });
            return { width, height, pixels };
        }

        // 1. Copy Text
        copyJsonBtn.addEventListener('click', () => {
            const data = getJsonData();
            const jsonString = JSON.stringify(data, null, 2);
            navigator.clipboard.writeText(jsonString).then(() => {
                const originalText = copyJsonBtn.innerText;
                copyJsonBtn.innerText = "Copied!";
                copyJsonBtn.style.backgroundColor = "#27ae60";
                setTimeout(() => {
                    copyJsonBtn.innerText = originalText;
                    copyJsonBtn.style.backgroundColor = "#f39c12";
                }, 1500);
            });
        });

        // 2. Download File
        saveJsonFileBtn.addEventListener('click', () => {
            const data = getJsonData();
            const jsonString = JSON.stringify(data, null, 2);
            const blob = new Blob([jsonString], { type: "application/json" });
            downloadBlob(blob, 'pixel-art.json');
        });

        // 3. Import (Modal)
        importBtn.addEventListener('click', () => {
            importModal.classList.remove('hidden');
            importText.value = ''; // clear previous
            importText.focus();
        });

        cancelImportBtn.addEventListener('click', () => {
            importModal.classList.add('hidden');
        });

        loadTextBtn.addEventListener('click', () => {
            const text = importText.value;
            if(!text.trim()) return;

            try {
                const data = JSON.parse(text);
                if (!data.width || !data.height || !data.pixels) {
                    alert('Invalid JSON format');
                    return;
                }
                
                // Update inputs
                widthInput.value = data.width;
                heightInput.value = data.height;

                // Create Grid
                makeGrid();

                // Fill Pixels
                const pixels = document.querySelectorAll('.pixel');
                data.pixels.forEach((color, index) => {
                    if (pixels[index]) pixels[index].style.backgroundColor = color;
                });

                saveState(); // Save to undo history
                importModal.classList.add('hidden');

            } catch (e) {
                alert('Error parsing JSON: ' + e.message);
            }
        });

        // Close modal on click outside
        importModal.addEventListener('click', (e) => {
            if(e.target === importModal) importModal.classList.add('hidden');
        });

        // Init
        window.onload = makeGrid;
    </script>
</body>
</html>